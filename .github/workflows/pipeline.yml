name: HOG/LBP/SVM Pipeline Training

on:
  # Trigger manually via GitHub Actions UI
  workflow_dispatch:
    inputs:
      pipeline_steps:
        description: 'Pipeline steps to run (comma-separated: normalize,sliding_window,feature_extraction,training,evaluation)'
        required: true
        default: 'normalize,sliding_window,feature_extraction,training,evaluation'
        type: string
      
      # Allow running specific steps
      run_normalization:
        description: 'Run image normalization'
        type: boolean
        default: true
        
      run_training:
        description: 'Run model training'
        type: boolean
        default: true
        
      run_evaluation:
        description: 'Run model evaluation'
        type: boolean
        default: true

  # Also trigger on push to main (optional)
  push:
    branches: [ main ]
    paths: 
      - 'HOG_Pipeline_App/**'
      - '.github/workflows/**'

jobs:
  pipeline_training:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hour timeout for large models
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10"]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true  # Enable Git LFS for large files
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1
        
    - name: Install Python dependencies
      working-directory: ./HOG_Pipeline_App
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify installation
      working-directory: ./HOG_Pipeline_App
      run: |
        python -c "import sklearn; print(f'scikit-learn: {sklearn.__version__}')"
        python -c "import skimage; print(f'scikit-image: {skimage.__version__}')"
        python -c "import cv2; print(f'opencv: {cv2.__version__}')"
        python -c "import numpy; print(f'numpy: {numpy.__version__}')"
        
    - name: Create necessary directories
      working-directory: ./HOG_Pipeline_App
      run: |
        mkdir -p temp/normalized_images
        mkdir -p temp/sliding_windows
        mkdir -p temp/extracted_features
        mkdir -p output/models
        mkdir -p output/figures
        mkdir -p output/evaluations
        
    - name: Run pipeline with error handling
      working-directory: ./HOG_Pipeline_App
      run: |
        set -e  # Exit on first error
        
        echo "Starting HOG/LBP/SVM Pipeline execution..."
        echo "Pipeline steps: ${{ github.event.inputs.pipeline_steps || 'normalize,sliding_window,feature_extraction,training,evaluation' }}"
        
        # Run the pipeline
        python pipeline.py \
          --steps "${{ github.event.inputs.pipeline_steps || 'normalize,sliding_window,feature_extraction,training,evaluation' }}" \
          --config config.yaml \
          --verbose
        
    - name: Upload training artifacts
      if: always()  # Run even if pipeline fails
      uses: actions/upload-artifact@v3
      with:
        name: pipeline-artifacts-${{ matrix.python-version }}
        path: |
          HOG_Pipeline_App/output/
          HOG_Pipeline_App/temp/
          HOG_Pipeline_App/logs/
        retention-days: 30
        
    - name: Upload model files
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: trained-models-${{ matrix.python-version }}
        path: |
          HOG_Pipeline_App/output/models/
        retention-days: 90
        
    - name: Upload evaluation results  
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: evaluation-results-${{ matrix.python-version }}
        path: |
          HOG_Pipeline_App/output/figures/
          HOG_Pipeline_App/output/evaluations/
        retention-days: 60
        
    - name: Generate pipeline summary
      if: always()
      working-directory: ./HOG_Pipeline_App
      run: |
        echo "## Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Steps Requested:** ${{ github.event.inputs.pipeline_steps || 'normalize,sliding_window,feature_extraction,training,evaluation' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "logs/pipeline.log" ]; then
          echo "- **Log File:** Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Last 20 log lines:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -n 20 logs/pipeline.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "output/models" ] && [ "$(ls -A output/models)" ]; then
          echo "- **Models Generated:** $(ls output/models/ | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- **Model Files:** $(ls output/models/)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "output/figures" ] && [ "$(ls -A output/figures)" ]; then
          echo "- **Visualizations:** $(ls output/figures/ | wc -l) files generated" >> $GITHUB_STEP_SUMMARY
        fi

  # Job to collect and compare results across Python versions
  comparison:
    needs: pipeline_training
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Compare results across Python versions
      run: |
        echo "## Multi-Version Comparison" >> $GITHUB_STEP_SUMMARY
        
        for version in "3.9" "3.10"; do
          artifact_dir="pipeline-artifacts-$version"
          if [ -d "$artifact_dir" ]; then
            echo "### Python $version Results:" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "$artifact_dir/output/models" ]; then
              model_count=$(find "$artifact_dir/output/models" -name "*.pkl" 2>/dev/null | wc -l)
              echo "- Models trained: $model_count" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f "$artifact_dir/output/figures" ]; then
              viz_count=$(find "$artifact_dir/output/figures" -name "*.png" 2>/dev/null | wc -l)
              echo "- Visualizations: $viz_count" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Python $version: Artifacts not found" >> $GITHUB_STEP_SUMMARY
          fi
        done